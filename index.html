<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<title>PAT Smart Inspector Pro v4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>

<style>
:root {
  --bg:#0a0c10; --card:#161b22; --accent:#238636; --text:#c9d1d9; --err:#da3633; --border:#30363d; --blue:#58a6ff;
}
body {
  background: var(--bg); color: var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  margin:0; padding:0; touch-action: manipulation;
}
.container { padding:15px; max-width:800px; margin:auto; }
.card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; margin-bottom:15px; }
h1,h2,h3 { color: var(--blue); margin-top:0; }
h1 { font-size:22px; text-align:center; margin-bottom:5px; }
h3 { font-size:16px; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
label { display:block; font-size:11px; color:#8b949e; margin-bottom:4px; text-transform:uppercase; }
input, select { width:100%; padding:12px; background:#0d1117; color:#fff; border:1px solid var(--border); border-radius:6px; box-sizing:border-box; margin-bottom:10px; font-size:14px; }
input:focus, select:focus { border-color:var(--blue); outline:none; }
.btn { padding:15px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; width:100%; font-size:14px; margin-bottom:8px; }
.btn-primary { background:var(--accent); color:white; }
.btn-outline { background:transparent; border:1px solid var(--blue); color:var(--blue); }
.btn-danger { background:var(--err); color:white; }
.btn-dup { background:#8957e5; color:white; padding:5px 10px; font-size:10px; width:auto; margin:0; }

.search-box { position:relative; }
.dropdown-list { position:absolute; top:100%; left:0; width:100%; z-index:100; background:#21262d; border:1px solid var(--border); border-radius:6px; max-height:200px; overflow-y:auto; display:none; }
.dropdown-list div { padding:12px; border-bottom:1px solid var(--border); font-size:14px; cursor:pointer; }
.dropdown-list div:hover { background:#30363d; }

table { width:100%; border-collapse:collapse; font-size:11px; margin-top:10px; }
th { background:#161b22; color:var(--blue); text-align:left; padding:8px; border-bottom:2px solid var(--border); }
td { padding:8px; border-bottom:1px solid var(--border); vertical-align: middle; }

.sig-wrapper { background:white; border-radius:8px; margin-top:5px; touch-action:none; position: relative; }
canvas { width:100%; height:140px; border-radius:8px; display: block; }

.status-pass { color:#3fb950; font-weight:bold; }
.status-fail { color:#f85149; font-weight:bold; }
</style>
</head>

<body>
<div class="container">
  <h1>PAT Smart Inspector Pro</h1>
  <small style="color:#8b949e; display:block; text-align:center; margin-bottom:15px;">IET 5th Edition Compliant (2026)</small>

  <details class="card" open>
    <summary><h3>1. Site & Client Details</h3></summary>
    <div class="grid">
      <div><label>Client Name</label><input type="text" id="clientName" placeholder="e.g. Costa Glasgow"></div>
      <div><label>Certificate No.</label><input type="text" id="certNo" value="CERT-2026-001"></div>
    </div>
    <label>Site Address</label>
    <input type="text" id="siteAddress" placeholder="Full address of inspection site">
    <div class="grid">
      <div><label>Engineer Name</label><input type="text" id="engName" placeholder="Your Name"></div>
      <div><label>Inspection Date</label><input type="date" id="testDate"></div>
    </div>
    <div class="grid">
      <div><label>Instrument Model</label><input type="text" id="testerModel" placeholder="e.g. Apollo 600+"></div>
      <div><label>Instrument S/N</label><input type="text" id="testerSerial" placeholder="Device Serial"></div>
    </div>
  </details>

  <div class="card">
    <h3>2. Appliance Inspection</h3>
    <div class="grid">
      <div><label>Asset ID</label><input type="text" id="assetId" value="APP-001"></div>
      <div class="search-box">
        <label>Location</label>
        <input type="text" id="location" placeholder="e.g. Main Kitchen" list="locList">
        <datalist id="locList">
            <option value="Kitchen"> <option value="Office"> <option value="Charity Shop Floor"> <option value="Workshop">
        </datalist>
      </div>
    </div>

    <div class="search-box">
      <label>Device Description</label>
      <input type="text" id="deviceDesc" placeholder="Type to search device..." oninput="filterDevices()">
      <div id="deviceDropdown" class="dropdown-list"></div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div>
        <label>Voltage</label>
        <select id="voltage"><option value="230V">230V</option><option value="110V">110V</option><option value="415V">415V</option></select>
      </div>
      <div>
        <label>Fuse Rating</label>
        <select id="fuse"><option>13A</option><option>5A</option><option>3A</option><option>N/A</option></select>
      </div>
    </div>

    <label>Visual Checks (Plug/Cable/Body)</label>
    <div class="grid">
      <div><label>Plug</label><select id="vPlug"><option>Pass</option><option>Fail</option></select></div>
      <div><label>Cable</label><select id="vCable"><option>Pass</option><option>Fail</option></select></div>
      <div><label>Body</label><select id="vBody"><option>Pass</option><option>Fail</option></select></div>
    </div>

    <div class="grid">
      <div>
        <label>Class</label>
        <select id="classType" onchange="toggleFields()">
          <option value="1">Class I (Earthed)</option>
          <option value="2">Class II (Double Insulated)</option>
        </select>
      </div>
      <div id="earthBox">
        <label>Earth Bond (Ω)</label>
        <input type="number" id="earthVal" step="0.01" placeholder="Max 0.1">
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Insulation (MΩ)</label>
        <input type="number" id="insulVal" step="0.1" placeholder="Min 1.0">
      </div>
      <div id="mwBox" style="display:none;">
        <label>MW Leakage (mW/cm²)</label>
        <input type="number" id="mwVal" step="0.01" value="0.01">
      </div>
    </div>

    <button class="btn btn-primary" onclick="addAppliance()">ADD APPLIANCE</button>
  </div>

  <div class="card" style="overflow-x:auto;">
    <h3>3. Records (<span id="count">0</span>)</h3>
    <table>
      <thead><tr><th>ID</th><th>Device</th><th>Location</th><th>Result</th><th>Action</th></tr></thead>
      <tbody id="recordBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>4. Formal Declaration</h3>
    <label>Engineer Signature</label>
    <div class="sig-wrapper"><canvas id="engSig"></canvas></div>
    <button class="btn btn-outline" style="padding:5px; margin-top:5px;" onclick="padEng.clear()">Clear Engineer</button>
    
    <label style="margin-top:15px;">Client Signature</label>
    <div class="sig-wrapper"><canvas id="cliSig"></canvas></div>
    <button class="btn btn-outline" style="padding:5px; margin-top:5px;" onclick="padCli.clear()">Clear Client</button>
  </div>

  <button class="btn btn-primary" style="height:60px; font-size:18px;" onclick="generateMasterPDF()">GENERATE COMPLIANCE REPORT</button>
  <div class="grid">
    <button class="btn btn-outline" onclick="emailReport()">Email to Client</button>
    <button class="btn btn-outline" onclick="addReminder()">Add Next Test to Calendar</button>
  </div>
  <button class="btn btn-danger" onclick="clearData()">Clear All Data</button>
</div>

<script>
// ====== Database & State ======
const deviceList = ["Kettle","Microwave","Toaster","Commercial Fridge","Coffee Machine","Deep Fryer","PC Tower","Monitor","Printer","Extension Lead","Vacuum Cleaner","Hand Drill","Bench Grinder","Heater (Fan)","Heater (Oil)","Laptop Charger","Floor Buffer","Pressure Washer","Charity Item (Audio)","Charity Item (Kitchen)","Meat Slicer","Dishwasher"];
let items = JSON.parse(localStorage.getItem('pat_data_v4')) || [];
document.getElementById('testDate').valueAsDate = new Date();

// ====== Initialize Signatures ======
const canvasEng = document.getElementById('engSig');
const canvasCli = document.getElementById('cliSig');
const padEng = new SignaturePad(canvasEng, {backgroundColor:'rgb(255,255,255)'});
const padCli = new SignaturePad(canvasCli, {backgroundColor:'rgb(255,255,255)'});

function resizeCanvas() {
    [canvasEng, canvasCli].forEach(c => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        c.width = c.offsetWidth * ratio;
        c.height = c.offsetHeight * ratio;
        c.getContext("2d").scale(ratio, ratio);
    });
}

// Safari Fix: Prevent scrolling while signing
[canvasEng, canvasCli].forEach(c => {
    c.addEventListener('touchstart', e => { if(e.target === c) e.preventDefault(); }, {passive:false});
    c.addEventListener('touchmove', e => { if(e.target === c) e.preventDefault(); }, {passive:false});
});

window.addEventListener('resize', resizeCanvas);
window.onload = () => { resizeCanvas(); renderTable(); updateAssetId(); };

// ====== Device Search Filter ======
function filterDevices(){
    const input = document.getElementById('deviceDesc');
    const dropdown = document.getElementById('deviceDropdown');
    const val = input.value.toLowerCase();
    dropdown.innerHTML = '';
    if(!val){ dropdown.style.display='none'; return; }
    const filtered = deviceList.filter(d=>d.toLowerCase().includes(val));
    if(filtered.length){
        dropdown.style.display='block';
        filtered.forEach(item=>{
            const div = document.createElement('div');
            div.textContent = item;
            div.onclick = ()=>{
                input.value = item;
                dropdown.style.display='none';
                document.getElementById('mwBox').style.display = item==="Microwave"?"block":"none";
            };
            dropdown.appendChild(div);
        });
    } else { dropdown.style.display='none'; }
}

function toggleFields(){
    const isClass2 = document.getElementById('classType').value==="2";
    const eb = document.getElementById('earthBox');
    eb.style.opacity = isClass2?"0.3":"1";
    document.getElementById('earthVal').disabled = isClass2;
}

// ====== Core Functions ======
function addAppliance(){
    const item = {
        id: document.getElementById('assetId').value,
        desc: document.getElementById('deviceDesc').value,
        loc: document.getElementById('location').value,
        cls: document.getElementById('classType').value,
        earth: document.getElementById('earthVal').value || '-',
        insul: document.getElementById('insulVal').value,
        mw: document.getElementById('mwVal').value,
        v: document.getElementById('voltage').value,
        f: document.getElementById('fuse').value,
        vP: document.getElementById('vPlug').value,
        vC: document.getElementById('vCable').value,
        vB: document.getElementById('vBody').value,
        status: "PASS"
    };

    // Validation logic
    if(item.vP==="Fail" || item.vC==="Fail" || item.vB==="Fail") item.status = "FAIL";
    if(item.cls==="1" && (parseFloat(item.earth)>0.1 || parseFloat(item.insul)<1)) item.status = "FAIL";
    if(item.cls==="2" && parseFloat(item.insul)<2) item.status = "FAIL";
    if(item.desc==="Microwave" && parseFloat(item.mw)>0.5) item.status = "FAIL";

    items.push(item);
    saveData();
    renderTable();
    updateAssetId();
    // Reset
    document.getElementById('deviceDesc').value = "";
    document.getElementById('earthVal').value = "";
    document.getElementById('insulVal').value = "";
}

function updateAssetId(){
    const nextNum = items.length + 1;
    document.getElementById('assetId').value = "APP-" + String(nextNum).padStart(3,'0');
}

function duplicateItem(idx){
    const copy = {...items[idx], id: "APP-" + String(items.length+1).padStart(3,'0')};
    items.push(copy);
    saveData(); renderTable(); updateAssetId();
}

function deleteItem(idx){ items.splice(idx,1); saveData(); renderTable(); updateAssetId(); }
function saveData(){ localStorage.setItem('pat_data_v4', JSON.stringify(items)); }

function renderTable(){
    const tbody = document.getElementById('recordBody');
    tbody.innerHTML = items.map((i,idx)=>`
        <tr>
            <td>${i.id}</td><td>${i.desc}</td><td>${i.loc}</td>
            <td class="${i.status==="PASS"?"status-pass":"status-fail"}">${i.status}</td>
            <td>
                <button class="btn-dup" onclick="duplicateItem(${idx})">Dup</button>
                <button style="background:none;border:none;color:red;font-weight:bold;" onclick="deleteItem(${idx})">✕</button>
            </td>
        </tr>
    `).join('');
    document.getElementById('count').innerText = items.length;
}

// ====== Output & Integration ======
async function generateMasterPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l','mm','a4');
    
    doc.setFontSize(22); doc.text("ELECTRICAL COMPLIANCE CERTIFICATE",14,20);
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text(`Client: ${document.getElementById('clientName').value} | Site: ${document.getElementById('siteAddress').value}`,14,30);
    doc.text(`Engineer: ${document.getElementById('engName').value} | Cert: ${document.getElementById('certNo').value}`,14,35);

    doc.autoTable({
        startY:45,
        head:[['Asset ID','Description','Location','Cls','V','Fuse','Earth','Insul','Plug/Cab/Bod','Status']],
        body:items.map(i=>[i.id,i.desc,i.loc,i.cls,i.v,i.f,i.earth,i.insul,`${i.vP}/${i.vC}/${i.vB}`,i.status]),
        headStyles:{fillColor:[35,134,54]},
        styles:{fontSize:8}
    });

    const finalY = doc.lastAutoTable.finalY + 10;
    if(!padEng.isEmpty()) doc.addImage(padEng.toDataURL(),'PNG',14,finalY,45,18);
    if(!padCli.isEmpty()) doc.addImage(padCli.toDataURL(),'PNG',100,finalY,45,18);
    doc.text("Engineer Signature",14,finalY+23);
    doc.text("Client Signature",100,finalY+23);

    doc.save(`PAT_Report_${document.getElementById('clientName').value}.pdf`);
}

function emailReport(){
    const subject = encodeURIComponent(`PAT Report - ${document.getElementById('clientName').value}`);
    const body = encodeURIComponent(`Hello,\nPlease find your PAT report attached.\nNext Test: ${new Date(new Date().setFullYear(new Date().getFullYear()+1)).toLocaleDateString()}`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

function addReminder(){
    const nextDate = new Date();
    nextDate.setFullYear(nextDate.getFullYear()+1);
    const start = nextDate.toISOString().replace(/-|:|\.\d+/g,"");
    window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=PAT+Testing+Renewal&dates=${start}/${start}`,'_blank');
}

function clearData(){ if(confirm("Clear all?")){ items=[]; saveData(); renderTable(); updateAssetId(); padEng.clear(); padCli.clear(); } }
</script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('pat-service-worker.js')
        .then(reg => console.log('Worker Registered'))
        .catch(err => console.log('Worker Failed', err));
    });
}
</body>
</html>
